lineage = cbind(mapping,lineage[,-1])
lineage$cell = unlist(lapply(strsplit(lineage$V1,"_"),function(x) x[1]))
df2 = subset(df,subclust_v6=="HSCs")
df.mg = merge(df2,lineage,by=c("cell","dataset"),all=T)
linNum=1
df.mg$lin = apply(df.mg[,paste0("Lineage_",c(1:3),"_prob")],1,which.max)
aggregate(TRS~lin,df.mg,median)
aggregate(trs_ex=="GWAS-enriched HSCs"~lin,df.mg,mean)
wilcox.test(df.mg$TRS[df.mg$lin==1],df.mg$TRS[df.mg$lin==2])
wilcox.test(df.mg$TRS[df.mg$lin==3],df.mg$TRS[df.mg$lin==2])
wilcox.test(df.mg$TRS[df.mg$lin==1],df.mg$TRS[df.mg$lin==3])
viridis = c("#440154FF", "#472D7BFF", "#3B528BFF", "#2C728EFF", "#21908CFF", "#27AD81FF",
"#5DC863FF", "#AADC32FF", "#FDE725FF")
library(ggplot2)
# tmp = aggregate(as.numeric(trs_ex=="GWAS-enriched HSCs")~as.factor(lin),df.mg,mean)
tmp = aggregate((TRS)~as.factor(lin),df.mg,median)
# p2 = ggplot(subset(df.mg,!is.na(TRS)),aes(x=as.factor(lin),y=scale(TRS))) +
#   geom_jitter(width=0.1,aes(col=trs_ex),alpha=0.6) +
#   geom_boxplot(outlier.shape=NA,alpha=0.8,fill='gray94',lwd=1,width=0.2,col="#FB8072") +
#   ggpubr::theme_pubr() +
#   labs(x="HSC Branch",y=paste0("SCAVENGE TRS (",traitName,")")) +
#   scale_color_manual(values=c(viridis[length(viridis)],viridis[3])) + labs(col="") +
#   scale_x_discrete(labels=paste0(tmp[,1],"\n (",round(tmp[,2]*100,1),"%)")); p2
p2 = ggplot(subset(df.mg,!is.na(TRS)),aes(x=as.factor(lin),y=(TRS))) +
# geom_jitter(width=0.1,aes(col=scale(TRS)),alpha=0.6) +
# geom_boxplot(outlier.shape=NA,alpha=0.8,fill='gray94',lwd=1,width=0.2,col="#FB8072") +
geom_jitter(width=0.15,aes(col=(TRS)),alpha=0.6) +
geom_boxplot(outlier.shape=NA,alpha=0.8,fill='gray94',lwd=1,width=0.3,col="#FB8072") +
ggpubr::theme_pubr() +
labs(x="HSC Branch",y=paste0("SCAVENGE TRS (",traitName,")")) +
guides(col="none") +
scale_color_gradient(high=viridis[length(viridis)],low=viridis[3]) + labs(col="") +
scale_x_discrete(labels=paste0(tmp[,1],"\n (",format(round(tmp[,2],2),nsmall = 2),")")); p2
f.plot = paste0("/Users/andrewmarderstein/Documents/Research/t21_multiome/output/scavenge_plots/HSCs.",traitName,".gwas_enriched.lin.boxplot.pdf")
pdf(f.plot,width=3.8,height=5)
print(p2)
dev.off()
}
# p2 = ggplot(subset(df.mg,!is.na(TRS)),aes(x=as.factor(lin),y=scale(TRS))) +
#   geom_jitter(width=0.1,aes(col=trs_ex),alpha=0.6) +
#   geom_boxplot(outlier.shape=NA,alpha=0.8,fill='gray94',lwd=1,width=0.2,col="#FB8072") +
#   ggpubr::theme_pubr() +
#   labs(x="HSC Branch",y=paste0("SCAVENGE TRS (",traitName,")")) +
#   scale_color_manual(values=c(viridis[length(viridis)],viridis[3])) + labs(col="") +
#   scale_x_discrete(labels=paste0(tmp[,1],"\n (",round(tmp[,2]*100,1),"%)")); p2
p2 = ggplot(subset(df.mg,!is.na(TRS)),aes(x=as.factor(lin),y=(TRS))) +
# geom_jitter(width=0.1,aes(col=scale(TRS)),alpha=0.6) +
# geom_boxplot(outlier.shape=NA,alpha=0.8,fill='gray94',lwd=1,width=0.2,col="#FB8072") +
geom_jitter(width=0.15,aes(col=(TRS)),alpha=0.6) +
geom_boxplot(outlier.shape=NA,alpha=0.8,fill='gray94',lwd=1,width=0.3,col="#FB8072") +
ggpubr::theme_pubr() +
labs(x="HSC Branch",y=paste0("SCAVENGE TRS (",traitName,")")) +
guides(col="none") +
scale_color_gradient(high=viridis[length(viridis)],low=viridis[3]) + labs(col="") +
scale_x_discrete(labels=paste0(tmp[,1])); p2
for (traitName in c("rbc","wbc","lymph")) {
f = paste0("~/Documents/Research/t21_multiome/output/scavenge/",traitName,".txt")
df = fread(f,data.table = F,stringsAsFactors = F)
df$trs_ex = df$TRS > quantile(df$TRS,probs=0.9)
df$trs_ex = ifelse(df$trs_ex,"GWAS-enriched HSCs","Other HSCs")
lineage = fread("~/Downloads/Lineage_Probabilities_per_Cell.csv",data.table = F,stringsAsFactors = F)
mapping = fread("~/Downloads/dataset_metadata_to_cell.csv",data.table = F,stringsAsFactors = F,header=T)
which(lineage$V1!=mapping$V1)
lineage = cbind(mapping,lineage[,-1])
lineage$cell = unlist(lapply(strsplit(lineage$V1,"_"),function(x) x[1]))
df2 = subset(df,subclust_v6=="HSCs")
df.mg = merge(df2,lineage,by=c("cell","dataset"),all=T)
linNum=1
df.mg$lin = apply(df.mg[,paste0("Lineage_",c(1:3),"_prob")],1,which.max)
aggregate(TRS~lin,df.mg,median)
aggregate(trs_ex=="GWAS-enriched HSCs"~lin,df.mg,mean)
wilcox.test(df.mg$TRS[df.mg$lin==1],df.mg$TRS[df.mg$lin==2])
wilcox.test(df.mg$TRS[df.mg$lin==3],df.mg$TRS[df.mg$lin==2])
wilcox.test(df.mg$TRS[df.mg$lin==1],df.mg$TRS[df.mg$lin==3])
viridis = c("#440154FF", "#472D7BFF", "#3B528BFF", "#2C728EFF", "#21908CFF", "#27AD81FF",
"#5DC863FF", "#AADC32FF", "#FDE725FF")
library(ggplot2)
# tmp = aggregate(as.numeric(trs_ex=="GWAS-enriched HSCs")~as.factor(lin),df.mg,mean)
tmp = aggregate((TRS)~as.factor(lin),df.mg,median)
# p2 = ggplot(subset(df.mg,!is.na(TRS)),aes(x=as.factor(lin),y=scale(TRS))) +
#   geom_jitter(width=0.1,aes(col=trs_ex),alpha=0.6) +
#   geom_boxplot(outlier.shape=NA,alpha=0.8,fill='gray94',lwd=1,width=0.2,col="#FB8072") +
#   ggpubr::theme_pubr() +
#   labs(x="HSC Branch",y=paste0("SCAVENGE TRS (",traitName,")")) +
#   scale_color_manual(values=c(viridis[length(viridis)],viridis[3])) + labs(col="") +
#   scale_x_discrete(labels=paste0(tmp[,1],"\n (",round(tmp[,2]*100,1),"%)")); p2
p2 = ggplot(subset(df.mg,!is.na(TRS)),aes(x=as.factor(lin),y=(TRS))) +
# geom_jitter(width=0.1,aes(col=scale(TRS)),alpha=0.6) +
# geom_boxplot(outlier.shape=NA,alpha=0.8,fill='gray94',lwd=1,width=0.2,col="#FB8072") +
geom_jitter(width=0.15,aes(col=(TRS)),alpha=0.6) +
geom_boxplot(outlier.shape=NA,alpha=0.8,fill='gray94',lwd=1,width=0.3,col="#FB8072") +
ggpubr::theme_pubr() +
labs(x="HSC Branch",y=paste0("SCAVENGE TRS (",traitName,")")) +
guides(col="none") +
scale_color_gradient(high=viridis[length(viridis)],low=viridis[3]) + labs(col="") +
scale_x_discrete(labels=paste0(tmp[,1])); p2
f.plot = paste0("/Users/andrewmarderstein/Documents/Research/t21_multiome/output/scavenge_plots/HSCs.",traitName,".gwas_enriched.lin.boxplot.pdf")
pdf(f.plot,width=3.8,height=5)
print(p2)
dev.off()
}
gene_of_interest = "TFR2"; peak_of_interest = "chr7-100639909-100642992"
# gene_of_interest = "ABCA7"; peak_of_interest = "chr19-1063288-1063650"
Idents(dfseurat) <- "kmeans_RNA"
df.sub2[1,]
library(data.table)
# 0. SCENT!
celltype_to_use="HSCs_H"
output_file = paste0("/Users/andrewmarderstein/Documents/Research/t21_multiome/output/scent/out1/",celltype_to_use,".txt")
res.df.h = fread(output_file,data.table = F,stringsAsFactors = F)
celltype_to_use="HSCs_T21"
output_file = paste0("/Users/andrewmarderstein/Documents/Research/t21_multiome/output/scent/out2/",celltype_to_use,".txt")
res.df.t21 = fread(output_file,data.table = F,stringsAsFactors = F)
ggplot(res.df.t21,aes(x=-log10(p),y=-log10(pval))) + geom_point() + geom_abline(slope=1,intercept=0)
res.df.mg = merge(res.df.h,res.df.t21,all=TRUE,by=c("gene","peak"))
# res.df.t21[order(res.df.t21$p - res.df.t21$pval,decreasing = T),][1:5,]
# seq(0,1,length.out=nrow(res.df.t21))
# tmp = data.frame(exp=-log10(seq(0,1,length.out=nrow(res.df.t21))),
# obs=sort(-log10(res.df.t21$pval),decreasing = T))
# ggplot(tmp,aes(x=exp,y=obs)) +  theme_bw() +
#   geom_point() + geom_abline(slope=1,intercept=0)
# ggplot(tmp,aes(x=exp,y=obs)) +  theme_bw() +
#   geom_point() + geom_abline(slope=1,intercept=0)
traitName="rbc"
# traitName="lymph"
# 1. find trait-associated SNPs
trait_fm = fread(paste0("/Users/andrewmarderstein/Documents/Research/t21_multiome/output/scent/out1/",traitName,"_peaks_overlap.bed"),data.table = F,stringsAsFactors = F)
trait_fm.sub = trait_fm[,c("V1","V3","V4","V5","V9")]
colnames(trait_fm.sub) = c("chr","snp_pos","rsid","pip","peak")
trait_fm.sub = subset(trait_fm,V5 > 0.2)[,c("V1","V3","V4","V5","V9")]
dim(trait_fm.sub)
nrow(subset(trait_fm,V5 > 0.9)[,c("V1","V3","V4","V5","V9")])
colnames(trait_fm.sub) = c("chr","snp_pos","rsid","pip","peak")
# b: subset to those SNPs that lie in SCENT peaks
trait_fm = fread("/Users/andrewmarderstein/Documents/Research/t21_multiome/output/scent/out1/rbc_peaks_overlap.bed",data.table = F,stringsAsFactors = F)
trait_fm.sub = trait_fm[,c("V1","V3","V4","V5","V9")]
colnames(trait_fm.sub) = c("chr","snp_pos","rsid","pip","peak")
trait_fm.sub = subset(trait_fm,V5 > 0.2)[,c("V1","V3","V4","V5","V9")]
dim(trait_fm.sub)
nrow(subset(trait_fm,V5 > 0.9)[,c("V1","V3","V4","V5","V9")])
colnames(trait_fm.sub) = c("chr","snp_pos","rsid","pip","peak")
# 2. find the subset of peaks that are linked to genes
# df.sub = merge(subset(res.df.mg,!is.na(beta.y) & fdr.y < 0.1),subset(trait_fm.sub,pip>0.2),by="peak")
df.sub = merge(res.df.mg,trait_fm.sub,by="peak",all.x=TRUE)
df.sub = df.sub[,c("chr","snp_pos","rsid","pip","peak","gene","beta.x","p.x","fdr.x","beta.y","pval","fdr.y")]
colnames(df.sub)[7:12] = c("beta_h","p_h","fdr_h","beta_t21","p_t21","fdr_t21")
# 3.
small_ATAC_pb = fread("~/Downloads/pb_de_atac.hsc.txt",data.table = F,stringsAsFactors = F)
large_RNA_pb = fread("~/Documents/Research/t21-proj/out/full/DE_pb_leiden_names/Liver.HSCs_MPPs.sample.txt",data.table = F,stringsAsFactors = F)
small_RNA_pb = fread("~/Downloads/pb_de.hsc.txt",data.table = F,stringsAsFactors = F)
cyc_HSC_pb = fread("~/Documents/Research/t21-proj/out/full/DE_pb_leiden_names/HSC_v_CyclingHSC.txt",data.table = F,stringsAsFactors = F)
cyc_HSC_pb$P.Value.rank = rank(cyc_HSC_pb$P.Value)/nrow(cyc_HSC_pb)
colnames(small_ATAC_pb) = paste0(colnames(small_ATAC_pb),"_smATAC")
colnames(large_RNA_pb) = paste0(colnames(large_RNA_pb),"_lgRNA")
colnames(small_RNA_pb) = paste0(colnames(small_RNA_pb),"_smRNA")
colnames(cyc_HSC_pb) = paste0(colnames(cyc_HSC_pb),"_cycHSC")
df.sub2 = merge(df.sub,small_ATAC_pb,by.x='peak',by.y='names_smATAC',all.x=T)
df.sub2 = merge(df.sub2,small_RNA_pb,by.x='gene',by.y='names_smRNA',all.x=T)
df.sub2 = merge(df.sub2,large_RNA_pb,by.x='gene',by.y='names_lgRNA',all.x=T)
df.sub2 = merge(df.sub2,cyc_HSC_pb,by.x='gene',by.y='names_cycHSC',all.x=T)
df.sub2$fm = !(df.sub2$pip <= 0.2 | is.na(df.sub2$pip))
df.sub2[1,]
subset(df.sub2,fdr_t21 < 0.1 & adj.P.Val_smATAC < 0.1 & adj.P.Val_lgRNA < 0.1)
df.sub2[1,]
subset(df.sub2,fdr_t21 < 0.1 & adj.P.Val_smATAC < 0.1 & adj.P.Val_lgRNA < 0.1 & adj.P.Val_smRNA < 0.1)
subset(df.sub2,fdr_t21 < 0.1 & adj.P.Val_smATAC < 0.1 & adj.P.Val_lgRNA < 0.1 & adj.P.Val_smRNA < 0.1 & fm)
subset(df.sub2,fdr_t21 < 0.1 & adj.P.Val_smATAC < 0.1 & adj.P.Val_lgRNA < 0.1 & P.Value_smRNA < 0.05 & fm)
subset(df.sub2,fdr_t21 < 0.1 & adj.P.Val_smATAC < 0.1 & adj.P.Val_lgRNA < 0.1 & P.Value_smRNA < 0.05 & fm)
subset(df.sub2,gene=="TFR2")
subset(df.sub2,fdr_t21 < 0.1 & adj.P.Val_smATAC < 0.1 & adj.P.Val_lgRNA < 0.1 & P.Value_smRNA < 0.05 & fm=="TRUE")
subset(df.sub2,gene=="TFR2")[2,]
subset(df.sub2,gene=="TFR2")[2,c("fdr_t21","adj.P.Val_smATAC","adj.P.Val_lgRNA","P.Value_smRNA","fm")]
subset(df.sub2,fdr_t21 < 0.1 & adj.P.Val_smATAC < 0.1 & adj.P.Val_lgRNA < 0.1 & P.Value_smRNA < 2 & fm=="TRUE")
subset(df.sub2,fdr_t21 < 0.1 & adj.P.Val_smATAC < 0.1 & adj.P.Val_lgRNA < 0.3 & P.Value_smRNA < 2 & fm=="TRUE")
subset(df.sub2,fdr_t21 < 0.1 & adj.P.Val_smATAC < 0.1 & adj.P.Val_lgRNA < 0.5 & P.Value_smRNA < 2 & fm=="TRUE")
subset(df.sub2,fdr_t21 < 0.1 & adj.P.Val_smATAC < 0.1 & adj.P.Val_lgRNA < 0.5 & P.Value_smRNA < 0.5 & fm=="TRUE")
subset(df.sub2,fdr_t21 < 0.1 & adj.P.Val_smATAC < 0.2 & adj.P.Val_lgRNA < 0.5 & P.Value_smRNA < 0.5 & fm=="TRUE")
subset(df.sub2,fdr_t21 < 0.1 & adj.P.Val_smATAC < 0.2 & adj.P.Val_lgRNA < 0.5 & P.Value_smRNA < 0.5 & fm=="TRUE")
subset(df.sub2,fdr_t21 < 0.1 & adj.P.Val_smATAC < 0.5 & adj.P.Val_lgRNA < 0.5 & P.Value_smRNA < 0.5 & fm=="TRUE")
subset(df.sub2,fdr_t21 < 0.1 & adj.P.Val_smATAC < 1 & adj.P.Val_lgRNA < 0.5 & P.Value_smRNA < 0.5 & fm=="TRUE")
df.sub2
subset(df.sub2,fdr_t21 < 0.1)
subset(df.sub2,fdr_t21 < 0.1 & fm=="TRUE")
subset(df.sub2,fdr_t21 < 0.1 & fm=="TRUE")
subset(df.sub2,gene=="ABCA7")
library("exact2x2")
res = list()
res[[1]] = exact2x2(df.sub2$p_t21 < 0.05,df.sub2$fm,alternative = 'two.sided')
res[[2]] = exact2x2(df.sub2$fdr_t21 < 0.1,df.sub2$fm,alternative = 'two.sided')
res[[3]] = exact2x2(df.sub2$fdr_t21 < 0.01,df.sub2$fm,alternative = 'two.sided')
df.sub3 = subset(df.sub2,p_t21 < 0.05)
res[[4]] = exact2x2(df.sub3$adj.P.Val_lgRNA < 0.1,df.sub3$fm,alternative = 'two.sided')
exact2x2(df.sub3$adj.P.Val_lgRNA < 0.1,df.sub3$fm,alternative = 'two.sided')
exact2x2(df.sub2$fdr_t21 < 0.2,df.sub2$fm,alternative = 'two.sided')
exact2x2(df.sub2$p_t21 < 0.05,df.sub2$fm,alternative = 'two.sided')
exact2x2(df.sub2$fdr_t21 < 0.1,df.sub2$fm,alternative = 'two.sided')
exact2x2(df.sub2$fdr_t21 < 0.2,df.sub2$fm,alternative = 'two.sided')
df.sub3 = subset(df.sub2,p_t21 < 0.05)
exact2x2(df.sub3$adj.P.Val_lgRNA < 0.1,df.sub3$fm,alternative = 'two.sided')
df.sub3 = subset(df.sub2,fdr_t21 < 0.2)
exact2x2(df.sub3$adj.P.Val_lgRNA < 0.1,df.sub3$fm,alternative = 'two.sided')
df.sub3 = subset(df.sub2,fdr_t21 < 0.1)
exact2x2(df.sub3$adj.P.Val_lgRNA < 0.1,df.sub3$fm,alternative = 'two.sided')
subset(df.sub2,fdr_t21 < 0.1 & fm=="TRUE")
subset(df.sub2,fdr_t21 < 0.2 & fm=="TRUE")
subset(df.sub2,fdr_t21 < 0.1 & adj.P.Val_smATAC < 0.1 & adj.P.Val_lgRNA < 0.1 & adj.P.Val_smRNA < 0.1 & fm)
subset(df.sub2,fdr_t21 < 0.1 & adj.P.Val_smATAC < 1 & adj.P.Val_lgRNA < 0.5 & P.Value_smRNA < 0.5 & fm=="TRUE")
subset(df.sub2,fdr_t21 < 0.1 & adj.P.Val_smATAC < 0.1 & adj.P.Val_lgRNA < 0.1 & P.Value_smRNA < 0.5 & fm=="TRUE")
subset(df.sub2,fdr_t21 < 0.1 & adj.P.Val_smATAC < 0.1 & adj.P.Val_lgRNA < 0.1 & P.Value_smRNA < 0.1 & fm=="TRUE")
subset(df.sub2,fdr_t21 < 0.1 & adj.P.Val_smATAC < 0.1 & adj.P.Val_lgRNA < 0.1 & P.Value_smRNA < 0.05 & fm=="TRUE")
subset(df.sub2,fdr_t21 < 0.1 & adj.P.Val_smATAC < 0.1 & adj.P.Val_lgRNA < 0.1 & P.Value_smRNA < 0.1 & fm=="TRUE")
subset(df.sub2,fdr_t21 < 0.1 & adj.P.Val_smATAC < 0.1 & adj.P.Val_lgRNA < 0.1 & P.Value_smRNA < 0.1 & fm=="TRUE")
subset(df.sub2,fdr_t21 < 0.2 & adj.P.Val_smATAC < 0.1 & adj.P.Val_lgRNA < 0.1 & P.Value_smRNA < 0.1 & fm=="TRUE")
subset(df.sub2,gene=="ABCA7")
subset(df.sub2,fdr_t21 < 0.2 & P.Value_smATAC < 0.1 & P.Value_lgRNA < 0.1 & P.Value_smRNA < 0.1 & fm=="TRUE")
subset(df.sub2,gene=="TFR2")[2,c("fdr_t21","adj.P.Val_smATAC","adj.P.Val_lgRNA","P.Value_smRNA","fm")]
subset(df.sub2,gene=="ABCA7")[2,c("fdr_t21","adj.P.Val_smATAC","adj.P.Val_lgRNA","P.Value_smRNA","fm")]
subset(df.sub2,gene=="ABCA7")[,c("fdr_t21","adj.P.Val_smATAC","adj.P.Val_lgRNA","P.Value_smRNA","fm")]
subset(df.sub2,gene=="ABCA7")[,c("fdr_t21","P.Value_smATAC","P.Value_lgRNA","P.Value_smRNA","fm")]
subset(df.sub2,fdr_t21 < 0.2 & P.Value_smATAC < 0.1 & P.Value_lgRNA < 0.1 & P.Value_smRNA < 0.1 & fm=="TRUE")
subset(df.sub2,fdr_t21 < 0.2 & P.Value_smATAC < 0.1 & P.Value_lgRNA < 0.1 & P.Value_smRNA < 0.2 & fm=="TRUE")
subset(df.sub2,fdr_t21 < 0.2 & P.Value_smATAC < 0.1 & P.Value_lgRNA < 0.1 & P.Value_smRNA < 0.5 & fm=="TRUE")
subset(df.sub2,fdr_t21 < 0.2 & P.Value_smATAC < 0.1 & P.Value_lgRNA < 0.1 & P.Value_smRNA < 0.9 & fm=="TRUE")
subset(df.sub2,fdr_t21 < 0.2 & P.Value_smATAC < 0.1 & P.Value_lgRNA < 1 & P.Value_smRNA < 0.1 & fm=="TRUE")
table(df.sub3$adj.P.Val_lgRNA < 0.1)
table(df.sub2$adj.P.Val_lgRNA < 0.1)
library("exact2x2")
res = list()
res[[1]] = exact2x2(df.sub2$p_t21 < 0.05,df.sub2$fm,alternative = 'two.sided')
res[[2]] = exact2x2(df.sub2$fdr_t21 < 0.2,df.sub2$fm,alternative = 'two.sided')
res[[3]] = exact2x2(df.sub2$fdr_t21 < 0.1,df.sub2$fm,alternative = 'two.sided')
# res[[3]] = exact2x2(df.sub2$fdr_t21 < 0.01,df.sub2$fm,alternative = 'two.sided')
df.sub3 = subset(df.sub2,p_t21 < 0.05)
res[[4]] = exact2x2(df.sub3$adj.P.Val_lgRNA < 0.1,df.sub3$fm,alternative = 'two.sided')
table(df.sub3$adj.P.Val_lgRNA < 0.1,df.sub3$fm)
df.sub3 = subset(df.sub2,fdr_t21 < 0.2)
res[[5]] = exact2x2(df.sub3$adj.P.Val_lgRNA < 0.1,df.sub3$fm,alternative = 'two.sided')
df.sub3 = subset(df.sub2,fdr_t21 < 0.1)
res[[6]] = exact2x2(df.sub3$adj.P.Val_lgRNA < 0.1,df.sub3$fm,alternative = 'two.sided')
# table(df.sub3$adj.P.Val_lgRNA < 0.1,df.sub3$fm)
# df.sub3 = subset(df.sub2,fdr_t21 < 0.01)
# res[[6]] = exact2x2(df.sub3$adj.P.Val_lgRNA < 0.1,df.sub3$fm,alternative = 'two.sided')
table(df.sub3$adj.P.Val_lgRNA < 0.1,df.sub3$fm)
# fisher.test(df.sub3$P.Value_lgRNA < 0.05 | df.sub3$P.Value_smRNA < 0.05,df.sub3$fm)
# fisher.test(df.sub3$P.Value_lgRNA < 0.05 | df.sub3$P.Value_smRNA < 0.05,df.sub3$fm)
df.sub3 = subset(df.sub2,fdr_t21 < 0.1)
table(df.sub3$adj.P.Val_lgRNA < 0.1,df.sub3$fm)
fisher.test(df.sub3$adj.P.Val_lgRNA < 0.1,df.sub3$fm)
binom.test(2,5,p=66/(693+66))
binom.test(24,(24+67),p=6621/(6621+31320))
# density plots
# ggplot(df.sub3,aes(x=-log10(adj.P.Val_lgRNA),fill=df.sub3$fm)) + geom_density(adjust=1/2,alpha=0.4)
# ggplot(df.sub3,aes(x=(adj.P.Val_lgRNA),fill=df.sub3$fm)) + geom_density(adjust=0.5,alpha=0.4) + theme_bw() + theme(panel.grid = element_blank())
# ggplot(df.sub2,aes(x=(p_t21),fill=fm)) + geom_density(adjust=0.5,alpha=0.4) + theme_bw() + theme(panel.grid = element_blank())
# ggplot(df.sub2,aes(x=(fdr_t21),fill=fm)) + geom_density(adjust=0.5,alpha=0.4) + theme_bw() + theme(panel.grid = element_blank())
# ggplot(df.sub3,aes(x=(P.Value_lgRNA),fill=df.sub3$fm)) + geom_density(adjust=1/2,alpha=0.4)
# ggplot(df.sub3,aes(x=-log10(P.Value_lgRNA),fill=df.sub3$fm)) + geom_density(adjust=1/2,alpha=0.4)
# ggplot(df.sub3,aes(x=(P.Value_lgRNA),col=df.sub3$fm)) + geom_histogram(stat='frequency')
# ggplot(df.sub3,aes(x=(P.Value_lgRNA),col=df.sub3$fm)) + geom_histogram(aes(y = after_stat(count / sum(count))))
df.sub3 = subset(df.sub2,fdr_t21 < 0.1)
fisher.test(df.sub3$P.Value_lgRNA < 0.05 | df.sub3$P.Value_smATAC < 0.05,df.sub3$fm)
table(df.sub3$P.Value_lgRNA < 0.05 | df.sub3$P.Value_smATAC < 0.05,df.sub3$fm)
fisher.test(df.sub3$P.Value_lgRNA < 0.05 & df.sub3$P.Value_smATAC < 0.05,df.sub3$fm)
fisher.test(df.sub3$adj.P.Val_lgRNA < 0.1 & df.sub3$adj.P.Val_smATAC < 0.1,df.sub3$fm)
fisher.test(df.sub3$adj.P.Val_lgRNA < 0.01 & df.sub3$adj.P.Val_smATAC < 0.01,df.sub3$fm)
estimate=unlist(lapply(res,function(x) x$estimate))
lower=unlist(lapply(res,function(x) x$conf.int[1]))
upper=unlist(lapply(res,function(x) x$conf.int[2]))
pvalue=unlist(lapply(res,function(x) x$p.value))
res <- data.frame(estimate, lower, upper,pvalue,row.names = NULL)
res$analy = NA
res$analy[1:3] = "Active cis-regulatory region\n(in T21 HSCs)"
res$analy[4:6] = "Differential expression of target GWAS genes\n(in large scRNA-seq HSCs)"
# res$analy[1:3] = "SNPs in active cis-regulatory region\n(in T21 HSCs)"
# res$analy[4:6] = "Targets genes are differentially expressed in T21\n(in large scRNA-seq HSCs)"
res$thres = NA
estimate=unlist(lapply(res,function(x) x$estimate))
lower=unlist(lapply(res,function(x) x$conf.int[1]))
upper=unlist(lapply(res,function(x) x$conf.int[2]))
pvalue=unlist(lapply(res,function(x) x$p.value))
res <- data.frame(estimate, lower, upper,pvalue,row.names = NULL)
res$analy = NA
res$analy[1:3] = "Active cis-regulatory region\n(in T21 HSCs)"
res$analy[4:6] = "Differential expression of target GWAS genes\n(in large scRNA-seq HSCs)"
# res$analy[1:3] = "SNPs in active cis-regulatory region\n(in T21 HSCs)"
# res$analy[4:6] = "Targets genes are differentially expressed in T21\n(in large scRNA-seq HSCs)"
res$thres = NA
res$thres[c(1,4)] = "P < 0.05"
res$thres[c(2,5)] = "FDR < 0.2"
res$thres[c(3,6)] = "FDR < 0.1"
res$analy = factor(res$analy,levels=rev(unique(res$analy)))
# levels(res$analy) = rev(unique(res$analy))
library(ggplot2)
estimate=unlist(lapply(res,function(x) x$estimate))
lower=unlist(lapply(res,function(x) x$conf.int[1]))
upper=unlist(lapply(res,function(x) x$conf.int[2]))
pvalue=unlist(lapply(res,function(x) x$p.value))
res <- data.frame(estimate, lower, upper,pvalue,row.names = NULL)
library("exact2x2")
res = list()
res[[1]] = exact2x2(df.sub2$p_t21 < 0.05,df.sub2$fm,alternative = 'two.sided')
res[[2]] = exact2x2(df.sub2$fdr_t21 < 0.2,df.sub2$fm,alternative = 'two.sided')
res[[3]] = exact2x2(df.sub2$fdr_t21 < 0.1,df.sub2$fm,alternative = 'two.sided')
# res[[3]] = exact2x2(df.sub2$fdr_t21 < 0.01,df.sub2$fm,alternative = 'two.sided')
df.sub3 = subset(df.sub2,p_t21 < 0.05)
res[[4]] = exact2x2(df.sub3$adj.P.Val_lgRNA < 0.1,df.sub3$fm,alternative = 'two.sided')
table(df.sub3$adj.P.Val_lgRNA < 0.1,df.sub3$fm)
df.sub3 = subset(df.sub2,fdr_t21 < 0.2)
res[[5]] = exact2x2(df.sub3$adj.P.Val_lgRNA < 0.1,df.sub3$fm,alternative = 'two.sided')
df.sub3 = subset(df.sub2,fdr_t21 < 0.1)
res[[6]] = exact2x2(df.sub3$adj.P.Val_lgRNA < 0.1,df.sub3$fm,alternative = 'two.sided')
# table(df.sub3$adj.P.Val_lgRNA < 0.1,df.sub3$fm)
res
df.sub3 = subset(df.sub2,fdr_t21 < 0.1)
fisher.test(df.sub3$P.Value_lgRNA < 0.05 | df.sub3$P.Value_smATAC < 0.05,df.sub3$fm)
table(df.sub3$P.Value_lgRNA < 0.05 | df.sub3$P.Value_smATAC < 0.05,df.sub3$fm)
fisher.test(df.sub3$P.Value_lgRNA < 0.05 & df.sub3$P.Value_smATAC < 0.05,df.sub3$fm)
fisher.test(df.sub3$adj.P.Val_lgRNA < 0.1 & df.sub3$adj.P.Val_smATAC < 0.1,df.sub3$fm)
fisher.test(df.sub3$adj.P.Val_lgRNA < 0.01 & df.sub3$adj.P.Val_smATAC < 0.01,df.sub3$fm)
estimate=unlist(lapply(res,function(x) x$estimate))
lower=unlist(lapply(res,function(x) x$conf.int[1]))
upper=unlist(lapply(res,function(x) x$conf.int[2]))
pvalue=unlist(lapply(res,function(x) x$p.value))
res <- data.frame(estimate, lower, upper,pvalue,row.names = NULL)
res$analy = NA
res$analy[1:3] = "Active cis-regulatory region\n(in T21 HSCs)"
res$analy[4:6] = "Differential expression of target GWAS genes\n(in large scRNA-seq HSCs)"
# res$analy[1:3] = "SNPs in active cis-regulatory region\n(in T21 HSCs)"
# res$analy[4:6] = "Targets genes are differentially expressed in T21\n(in large scRNA-seq HSCs)"
res$thres = NA
res$thres[c(1,4)] = "P < 0.05"
res$thres[c(2,5)] = "FDR < 0.2"
res$thres[c(3,6)] = "FDR < 0.1"
res$analy = factor(res$analy,levels=rev(unique(res$analy)))
# levels(res$analy) = rev(unique(res$analy))
library(ggplot2)
g=ggplot(subset(res,thres!="FDR < 0.01"),aes(x=analy,y=estimate,ymin=lower,ymax=upper,col=thres)) +
scale_color_manual(values=c("Blue","Purple","DarkRed")) +
ggpubr::theme_pubr() +
theme(axis.text.x = element_text(angle=90)) +
coord_flip() +
geom_errorbar(width=0.3,position=position_dodge(width=0.5)) +
geom_point(position=position_dodge(width=0.5),size=rel(3)) +
labs(x="",y="RBC GWAS Enrichment (OR)",col="Peak-gene threshold") +
geom_hline(yintercept = 1,col='red',lty='dashed',lwd=1) +
scale_y_continuous(trans="log10");g
f.plot = paste0("/Users/andrewmarderstein/Documents/Research/t21_multiome/output/scavenge_plots/HSCs.",traitName,".SCENT_enrich.boot.pdf")
pdf(f.plot,height=1.37*2,width=4.2*2)
print(g)
dev.off()
library(ggplot2)
library(Seurat)
library(Signac)
dir="/oak/stanford/groups/smontgom/amarder/neuro-variants"
library(data.table)
# 0. SCENT!
celltype_to_use="HSCs_H"
output_file = paste0("/Users/andrewmarderstein/Documents/Research/t21_multiome/output/scent/out1/",celltype_to_use,".txt")
res.df.h = fread(output_file,data.table = F,stringsAsFactors = F)
celltype_to_use="HSCs_T21"
output_file = paste0("/Users/andrewmarderstein/Documents/Research/t21_multiome/output/scent/out2/",celltype_to_use,".txt")
res.df.t21 = fread(output_file,data.table = F,stringsAsFactors = F)
ggplot(res.df.t21,aes(x=-log10(p),y=-log10(pval))) + geom_point() + geom_abline(slope=1,intercept=0)
res.df.mg = merge(res.df.h,res.df.t21,all=TRUE,by=c("gene","peak"))
head(res.df.mg)
ggplot(res.df.mg,aes(x=beta.x,y=beta.y)) + geom_point()
ggplot(res.df.mg,aes(x=beta.x,y=beta.y)) + geom_point() + geom_smooth()
ggplot(res.df.mg,aes(x=beta.x,y=beta.y)) + geom_point() + geom_smooth(method='lm')
cor(res.df.mg$beta.x,res.df.mg$beta.y)
cor(res.df.mg$beta.x,res.df.mg$beta.y,use='na.or.complete')
cor.test(res.df.mg$beta.x,res.df.mg$beta.y,use='na.or.complete')
cor(res.df.mg$beta.x,res.df.mg$beta.y,use='na.or.complete')
res.df.mg[1,]
subset(res.df.mg,fdr.x < 0.1 & fdr.y < 0.1 & sign(beta.x)!=sign(beta.y))
subset(res.df.mg,fdr.x < 0.1 & fdr.y < 0.1 & sign(beta.x)==sign(beta.y))
subset(res.df.mg,fdr.x < 0.1 & fdr.y < 0.1 & sign(beta.x)!=sign(beta.y))
subset(res.df.mg,fdr.x < 0.2 & fdr.y < 0.2 & sign(beta.x)!=sign(beta.y))
subset(res.df.mg,fdr.x < 0.2 & fdr.y < 0.2 & sign(beta.x)!=sign(beta.y))
ggplot(res.df.mg,aes(x=-log10(p.x),y=-log10(p.y),col=sign(beta.x)!=sign(beta.y))) + geom_point() + geom_smooth(method='lm')
ggplot(res.df.mg,aes(x=-log10(p.x),y=-log10(p.y),col=sign(beta.x)!=sign(beta.y))) + geom_point() #+ geom_smooth(method='lm')
ggplot(res.df.mg,aes(x=-log10(pval.x),y=-log10(p.y),col=sign(beta.x)!=sign(beta.y))) + geom_point() #+ geom_smooth(method='lm')
ggplot(res.df.mg,aes(x=-log10(pval),y=-log10(p.y),col=sign(beta.x)!=sign(beta.y))) + geom_point() #+ geom_smooth(method='lm')
ggplot(res.df.mg,aes(x=-log10(fdr.x),y=-log10(fdr.y),col=sign(beta.x)!=sign(beta.y))) + geom_point() #+ geom_smooth(method='lm')
tmp = subset(res.df.mg,fdr.x < 0.2 & fdr.y < 0.2); table(sign(tmp$beta.x) != sign(tmp$beta.y))
tmp = subset(res.df.mg,fdr.x < 0.2 & fdr.y < 0.2); table(sign(tmp$beta.x) != sign(tmp$beta.y))
tmp = subset(res.df.mg,fdr.x < 0.1 & fdr.y < 0.1); table(sign(tmp$beta.x) != sign(tmp$beta.y))
table(res.df.mg$fdr.x < 0.1)
table(res.df.mg$fdr.y < 0.1)
dim(res.df.mg)
table(res.df.t21$fdr.x < 0.1)
table(res.df.t21$fdr < 0.1)
table(res.df.h$fdr < 0.1)
table(res.df.t21$fdr < 0.1)
table(res.df.t21$fdr < 0.2)
table(res.df.h$fdr < 0.2)
tmp = subset(res.df.mg,fdr.x < 0.1 & fdr.y < 0.1); table(sign(tmp$beta.x) != sign(tmp$beta.y))
subset(res.df.mg,fdr.x < 0.2 & fdr.y < 0.2 & sign(beta.x)!=sign(beta.y))
table(res.df.t21$fdr < 0.2 & res.df.h$fdr < 0.2)
table(res.df.t21$fdr < 0.2 & res.df.h$fdr < 0.2)
table(res.df.t21$fdr < 0.2, res.df.h$fdr < 0.2)
table(res.df.mg$fdr < 0.2, res.df.mg$fdr < 0.2)
table(res.df.mg$fdr.x < 0.2, res.df.mg$fdr.y < 0.2)
res.df.mg[order(res.df.mg$pval-res.df.mg$p.y),][1,]
res.df.mg[order(res.df.mg$pval-res.df.mg$p.y,decreasing = T),][1,]
table(res.df.mg$fdr.x < 0.2, res.df.mg$fdr.y < 0.2)
fisher.test(res.df.mg$fdr.x < 0.2, res.df.mg$fdr.y < 0.2)
table(res.df.mg$fdr.x < 0.2, res.df.mg$fdr.y < 0.2)
sum(res.df.mg$fdr.y < 0.2)
table(res.df.t21$fdr < 0.2)
table(res.df.mg$fdr.y < 0.2)
table(res.df.mg$fdr.x < 0.2, res.df.mg$fdr.y < 0.2)
table(res.df.mg$fdr.x < 0.2 & res.df.mg$fdr.y < 0.2)
table(res.df.mg$fdr.x < 0.2 | res.df.mg$fdr.y < 0.2)
df.sub2[df.sub2$gene=="KLF6"]
df.sub2[df.sub2$gene=="KLF6",]
library("exact2x2")
library(data.table)
df = fread("~/Documents/Research/t21_multiome/output/scent/out_split/all/HSCs.DE.int.txt",data.table = F,stringsAsFactors = F)
head(df)
dim(df)
library("exact2x2")
library(data.table)
df = fread("~/Documents/Research/t21_multiome/output/scent/out_split/all/HSCs.DE.int.txt",data.table = F,stringsAsFactors = F)
dim(df)
res = list()
res[[1]] = exact2x2(df.sub2$p_t21 < 0.05,df.sub2$fm,alternative = 'two.sided')
res[[2]] = exact2x2(df.sub2$fdr_t21 < 0.2,df.sub2$fm,alternative = 'two.sided')
res[[3]] = exact2x2(df.sub2$fdr_t21 < 0.1,df.sub2$fm,alternative = 'two.sided')
library("exact2x2")
library(data.table)
df = fread("~/Documents/Research/t21_multiome/output/scent/out_split/all/HSCs.DE.int.txt",data.table = F,stringsAsFactors = F)
dim(df)
res = list()
res[[1]] = exact2x2(df.sub2$p_t21 < 0.05,df.sub2$fm,alternative = 'two.sided')
res[[2]] = exact2x2(df.sub2$fdr_t21 < 0.2,df.sub2$fm,alternative = 'two.sided')
res[[3]] = exact2x2(df.sub2$fdr_t21 < 0.1,df.sub2$fm,alternative = 'two.sided')
df.sub2 = fread("~/Documents/Research/t21_multiome/output/scent/out_split/all/HSCs.DE.int.txt",data.table = F,stringsAsFactors = F)
res = list()
res[[1]] = exact2x2(df.sub2$p_t21 < 0.05,df.sub2$fm,alternative = 'two.sided')
res[[2]] = exact2x2(df.sub2$fdr_t21 < 0.2,df.sub2$fm,alternative = 'two.sided')
res[[3]] = exact2x2(df.sub2$fdr_t21 < 0.1,df.sub2$fm,alternative = 'two.sided')
# res[[3]] = exact2x2(df.sub2$fdr_t21 < 0.01,df.sub2$fm,alternative = 'two.sided')
df.sub3 = subset(df.sub2,p_t21 < 0.05)
res[[4]] = exact2x2(df.sub3$adj.P.Val_lgRNA < 0.1,df.sub3$fm,alternative = 'two.sided')
table(df.sub3$P.Value_smRNA < 0.05,df.sub3$fm)
df.sub3 = subset(df.sub2,fdr_t21 < 0.2)
res[[5]] = exact2x2(df.sub3$adj.P.Val_lgRNA < 0.1,df.sub3$fm,alternative = 'two.sided')
table(df.sub3$adj.P.Val_lgRNA < 0.1,df.sub3$fm)
subset(df.sub3,adj.P.Val_lgRNA < 0.1 & fm)
df.sub3 = subset(df.sub2,fdr_t21 < 0.1)
res[[6]] = exact2x2(df.sub3$adj.P.Val_lgRNA < 0.1,df.sub3$fm,alternative = 'two.sided')
table(df.sub3$adj.P.Val_lgRNA < 0.1,df.sub3$fm)
# fisher.test(df.sub3$P.Value_lgRNA < 0.05 | df.sub3$P.Value_smRNA < 0.05,df.sub3$fm)
# fisher.test(df.sub3$P.Value_lgRNA < 0.05 | df.sub3$P.Value_smRNA < 0.05,df.sub3$fm)
df.sub3 = subset(df.sub2,fdr_t21 < 0.1)
table(df.sub3$adj.P.Val_lgRNA < 0.1,df.sub3$fm)
fisher.test(df.sub3$adj.P.Val_lgRNA < 0.1,df.sub3$fm)
binom.test(2,5,p=66/(693+66))
binom.test(24,(24+67),p=6621/(6621+31320))
df.sub3 = subset(df.sub2,fdr_t21 < 0.1)
fisher.test(df.sub3$P.Value_lgRNA < 0.05 | df.sub3$P.Value_smATAC < 0.05,df.sub3$fm)
table(df.sub3$P.Value_lgRNA < 0.05 | df.sub3$P.Value_smATAC < 0.05,df.sub3$fm)
fisher.test(df.sub3$P.Value_lgRNA < 0.05 & df.sub3$P.Value_smATAC < 0.05,df.sub3$fm)
fisher.test(df.sub3$adj.P.Val_lgRNA < 0.1 & df.sub3$adj.P.Val_smATAC < 0.1,df.sub3$fm)
fisher.test(df.sub3$adj.P.Val_lgRNA < 0.01 & df.sub3$adj.P.Val_smATAC < 0.01,df.sub3$fm)
estimate=unlist(lapply(res,function(x) x$estimate))
lower=unlist(lapply(res,function(x) x$conf.int[1]))
upper=unlist(lapply(res,function(x) x$conf.int[2]))
pvalue=unlist(lapply(res,function(x) x$p.value))
res <- data.frame(estimate, lower, upper,pvalue,row.names = NULL)
res$analy = NA
res$analy[1:3] = "Active cis-regulatory region\n(in T21 HSCs)"
res$analy[4:6] = "Differential expression of target GWAS genes\n(in large scRNA-seq HSCs)"
# res$analy[1:3] = "SNPs in active cis-regulatory region\n(in T21 HSCs)"
# res$analy[4:6] = "Targets genes are differentially expressed in T21\n(in large scRNA-seq HSCs)"
res$thres = NA
res$thres[c(1,4)] = "P < 0.05"
res$thres[c(2,5)] = "FDR < 0.2"
res$thres[c(3,6)] = "FDR < 0.1"
res$analy = factor(res$analy,levels=rev(unique(res$analy)))
# levels(res$analy) = rev(unique(res$analy))
library(ggplot2)
g=ggplot(subset(res,thres!="FDR < 0.01"),aes(x=analy,y=estimate,ymin=lower,ymax=upper,col=thres)) +
scale_color_manual(values=c("Blue","Purple","DarkRed")) +
ggpubr::theme_pubr() +
theme(axis.text.x = element_text(angle=90)) +
coord_flip() +
geom_errorbar(width=0.3,position=position_dodge(width=0.5)) +
geom_point(position=position_dodge(width=0.5),size=rel(3)) +
labs(x="",y="RBC GWAS Enrichment (OR)",col="Peak-gene threshold") +
geom_hline(yintercept = 1,col='red',lty='dashed',lwd=1) +
scale_y_continuous(trans="log10");g
f.plot = paste0("/Users/andrewmarderstein/Documents/Research/t21_multiome/output/scavenge_plots/HSCs.",traitName,".SCENT_enrich.boot.pdf")
pdf(f.plot,height=1.37*2,width=4.2*2)
print(g)
dev.off()
traitName="rbc"
f.plot = paste0("/Users/andrewmarderstein/Documents/Research/t21_multiome/output/scavenge_plots/HSCs.",traitName,".SCENT_enrich.boot.pdf")
pdf(f.plot,height=1.37*2,width=4.2*2)
print(g)
dev.off()
fisher.test(df.sub3$adj.P.Val_lgRNA < 0.1,df.sub3$fm)
library(ggplot2)
library(edgeR)
library(data.table)
geneName="TFR2"
# out = readRDS("~/Documents/Research/t21-proj/out/full/data_pb_leiden/Liver.pb.HSCs_MPPs.txt")
# df.aggre = out[[1]]
# metadata_to_use = out[[2]]
df.aggre = fread("~/Documents/Research/t21-proj/out/full/data_pb_leiden/Liver.pb.HSCs_MPPs.sample.txt",data.table = F,stringsAsFactors = F)
rownames(df.aggre) =df.aggre[,1]; df.aggre =  df.aggre[,-1]
df.aggre.cpm = cpm(df.aggre)
